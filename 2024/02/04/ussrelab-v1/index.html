

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Felix Yang">
  <meta name="keywords" content="Python,SRE,Flask,AWS,Azure,运维， 读书">
  
    <meta name="description" content="[TOC]  Setting Up LABInstall AD and DNSInstall ADCS (Root CA authority) on ADFS VMStep 1: Install ADCS Role Open Server Manager: Click on the Start button, then click on Server Manager. Add Roles and">
<meta property="og:type" content="article">
<meta property="og:title" content="USSRELAB - Vision One SSO with ADFS Idp and ZTSA Testing">
<meta property="og:url" content="https://blog.excelsre.com/2024/02/04/ussrelab-v1/index.html">
<meta property="og:site_name" content="Felix Yang&#39;s Blog">
<meta property="og:description" content="[TOC]  Setting Up LABInstall AD and DNSInstall ADCS (Root CA authority) on ADFS VMStep 1: Install ADCS Role Open Server Manager: Click on the Start button, then click on Server Manager. Add Roles and">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/05/image-20240204220718541.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/05/image-20240204224848224.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205162005715.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205111831551.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205111630206.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205113258875.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205113545043.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205113646124.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205113729972.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205114411368.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205120125707.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205120313293.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205120217988.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205114817897.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205115329917.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205115418648.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205115854740.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205115759167.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205115820278.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205114632768.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205120705070.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205120736731.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205120809525.png">
<meta property="og:image" content="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205120837956.png">
<meta property="article:published_time" content="2024-02-05T04:10:07.572Z">
<meta property="article:modified_time" content="2024-02-05T22:24:27.321Z">
<meta property="article:author" content="Felix Yang">
<meta property="article:tag" content="V1">
<meta property="article:tag" content="Trend">
<meta property="article:tag" content="ADFS">
<meta property="article:tag" content="Service Gateway">
<meta property="article:tag" content="ZTSA">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://felixyanghui.synology.me:8441/images/2024/02/05/image-20240204220718541.png">
  
  
  
  <title>USSRELAB - Vision One SSO with ADFS Idp and ZTSA Testing - Felix Yang&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.excelsre.com","root":"/","version":"1.9.5-a","typing":{"enable":true,"typeSpeed":120,"cursorChar":"_","loop":false,"scope":["home"]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Felix Yang's Blog" type="application/atom+xml">
<link rel="alternate" href="/rss2.xml" title="Felix Yang's Blog" type="application/rss+xml">
</head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>大良造</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">USSRELAB - Vision One SSO with ADFS Idp and ZTSA Testing</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-02-05 12:10" pubdate>
          2024年2月5日 中午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          12k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          100 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">USSRELAB - Vision One SSO with ADFS Idp and ZTSA Testing</h1>
            
            
              <div class="markdown-body">
                
                <p>[TOC]</p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/05/image-20240204220718541.png" srcset="/img/loading.gif" lazyload alt="image-20240204220718541"></p>
<h1 id="Setting-Up-LAB"><a href="#Setting-Up-LAB" class="headerlink" title="Setting Up LAB"></a>Setting Up LAB</h1><h2 id="Install-AD-and-DNS"><a href="#Install-AD-and-DNS" class="headerlink" title="Install AD and DNS"></a>Install AD and DNS</h2><h2 id="Install-ADCS-Root-CA-authority-on-ADFS-VM"><a href="#Install-ADCS-Root-CA-authority-on-ADFS-VM" class="headerlink" title="Install ADCS (Root CA authority) on ADFS VM"></a>Install ADCS (Root CA authority) on ADFS VM</h2><h4 id="Step-1-Install-ADCS-Role"><a href="#Step-1-Install-ADCS-Role" class="headerlink" title="Step 1: Install ADCS Role"></a>Step 1: Install ADCS Role</h4><ol>
<li><strong>Open Server Manager</strong>: Click on the <strong>Start</strong> button, then click on <strong>Server Manager</strong>.</li>
<li><strong>Add Roles and Features</strong>: In the Server Manager dashboard, click on <strong>Manage</strong> and select <strong>Add Roles and Features</strong>.</li>
<li><strong>Before You Begin</strong>: Click <strong>Next</strong> on the “Before you begin” page, if displayed.</li>
<li><strong>Installation Type</strong>: Choose <strong>Role-based or feature-based installation</strong> and click <strong>Next</strong>.</li>
<li><strong>Server Selection</strong>: Ensure the correct server is selected and click <strong>Next</strong>.</li>
<li><strong>Server Roles</strong>: Scroll down and check <strong>Active Directory Certificate Services</strong>. When prompted to add features that are required for Active Directory Certificate Services, click <strong>Add Features</strong>, then click <strong>Next</strong>.</li>
<li><strong>Features</strong>: No additional features are needed unless you have specific requirements. Click <strong>Next</strong>.</li>
<li><strong>AD CS</strong>: You will see an information screen about AD CS. Click <strong>Next</strong>.</li>
<li><strong>Role Services</strong>: Choose the services you need. For a basic CA, check <strong>Certification Authority</strong>. You might also want to select <strong>Certification Authority Web Enrollment</strong> for web-based certificate requests, <strong>Online Responder</strong> for OCSP, etc., depending on your needs. Click <strong>Next</strong> after selection.</li>
<li><strong>Confirmation</strong>: Review your selections. Optionally, you can select <strong>Restart the destination server automatically if required</strong>. Click <strong>Install</strong>.</li>
<li><strong>Results</strong>: Wait for the installation to complete and click <strong>Close</strong>.</li>
</ol>
<h4 id="Step-2-Configure-ADCS"><a href="#Step-2-Configure-ADCS" class="headerlink" title="Step 2: Configure ADCS"></a>Step 2: Configure ADCS</h4><p>After installing ADCS, you need to configure the role services, starting with the Certification Authority.</p>
<ol>
<li><strong>Post-Installation Configuration</strong>: In Server Manager, you will see a notification flag with a warning symbol. Click on it and choose <strong>Configure Active Directory Certificate Services on the destination server</strong>.</li>
<li><strong>Credentials</strong>: The AD CS Configuration wizard opens. If prompted, provide credentials that have enterprise admin permissions.</li>
<li><strong>Role Services</strong>: Select <strong>Certification Authority</strong> and any other role services you installed that need configuration. Click <strong>Next</strong>.</li>
<li><strong>Setup Type</strong>: Choose <strong>Enterprise CA</strong> if your organization uses Active Directory. Choose <strong>Standalone CA</strong> if not. Most scenarios require an Enterprise CA. Click <strong>Next</strong>.</li>
<li><strong>CA Type</strong>: Select the type of CA. Options include <strong>Root CA</strong> or <strong>Subordinate CA</strong>. Choose <strong>Root CA</strong> if this is the first or only CA in your network. Click <strong>Next</strong>.</li>
<li><strong>Private Key</strong>: Choose to <strong>Create a new private key</strong>. If configuring a Subordinate CA and you’ve received a certificate from an external CA, you would choose the other option. Click <strong>Next</strong>.</li>
<li><strong>Cryptographic Options</strong>: Choose the cryptographic service provider (CSP), hash algorithm, and key length. The defaults are generally acceptable, but ensure they meet your organization’s security policies. Click <strong>Next</strong>.</li>
<li><strong>CA Name</strong>: Specify the name of your CA. This name will appear on issued certificates. Click <strong>Next</strong>.</li>
<li><strong>Validity Period</strong>: Set the validity period for the CA’s certificate. This depends on your organization’s policy and the role of this CA. Click <strong>Next</strong>.</li>
<li><strong>Certificate Database</strong>: Specify locations for the certificate database and the certificate database log. The default locations are usually fine unless you have specific storage requirements. Click <strong>Next</strong>.</li>
<li><strong>Confirmation</strong>: Review your selections and click <strong>Configure</strong>.</li>
<li><strong>Results</strong>: After configuration completes, click <strong>Close</strong>.</li>
</ol>
<h4 id="Step-3-Verify-Installation"><a href="#Step-3-Verify-Installation" class="headerlink" title="Step 3: Verify Installation"></a>Step 3: Verify Installation</h4><ul>
<li><strong>Open Certification Authority Console</strong>: Open Server Manager, click on <strong>Tools</strong>, and select <strong>Certification Authority</strong>. This opens the Certification Authority MMC snap-in.</li>
<li><strong>Check the CA Status</strong>: In the Certification Authority console, your new CA should be listed and running.</li>
</ul>
<h3 id="Create-the-certificate-for-ADFS-server"><a href="#Create-the-certificate-for-ADFS-server" class="headerlink" title="Create the certificate for ADFS server"></a>Create the certificate for ADFS server</h3><h4 id="Step-1-Create-a-Certificate-Signing-Request-CSR"><a href="#Step-1-Create-a-Certificate-Signing-Request-CSR" class="headerlink" title="Step 1: Create a Certificate Signing Request (CSR)"></a>Step 1: Create a Certificate Signing Request (CSR)</h4><ol>
<li><p><strong>Create an INF File</strong>: First, create an INF file (e.g., <code>csr.inf</code>) that specifies the properties of the certificate you wish to request. Open Notepad, paste the following content, and adjust it as needed for your situation:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-section">[NewRequest]</span><br><span class="hljs-attr">Subject</span> = <span class="hljs-string">&quot;CN=adfs.ussrelab.com&quot;</span><br><span class="hljs-attr">KeySpec</span> = <span class="hljs-number">1</span><br><span class="hljs-attr">KeyLength</span> = <span class="hljs-number">2048</span><br><span class="hljs-attr">Exportable</span> = <span class="hljs-literal">TRUE</span><br><span class="hljs-attr">MachineKeySet</span> = <span class="hljs-literal">TRUE</span><br><span class="hljs-attr">SMIME</span> = <span class="hljs-literal">False</span><br><span class="hljs-attr">PrivateKeyArchive</span> = <span class="hljs-literal">FALSE</span><br><span class="hljs-attr">UserProtected</span> = <span class="hljs-literal">FALSE</span><br><span class="hljs-attr">UseExistingKeySet</span> = <span class="hljs-literal">FALSE</span><br><span class="hljs-attr">ProviderName</span> = <span class="hljs-string">&quot;Microsoft RSA SChannel Cryptographic Provider&quot;</span><br><span class="hljs-attr">ProviderType</span> = <span class="hljs-number">12</span><br><span class="hljs-attr">RequestType</span> = PKCS10<br><span class="hljs-attr">KeyUsage</span> = <span class="hljs-number">0</span>xa0<br><br><span class="hljs-section">[EnhancedKeyUsageExtension]</span><br><span class="hljs-attr">OID</span>=<span class="hljs-number">1.3</span>.<span class="hljs-number">6.1</span>.<span class="hljs-number">5.5</span>.<span class="hljs-number">7.3</span>.<span class="hljs-number">1</span> <span class="hljs-comment">; Server Authentication</span><br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>Generate the CSR</strong>: Open Command Prompt as Administrator and run the following command to generate the CSR:</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">certreq -new csr.inf adfs.csr<br></code></pre></td></tr></table></figure></li>
</ol>
<h4 id="Step-2-Submit-the-CSR-to-Your-CA"><a href="#Step-2-Submit-the-CSR-to-Your-CA" class="headerlink" title="Step 2: Submit the CSR to Your CA"></a>Step 2: Submit the CSR to Your CA</h4><p><strong>Submit the CSR</strong>: Use the <code>certreq</code> command to submit the CSR to your CA. Replace <code>CAName</code> with the name of your CA, and adjust the template name (<code>TemplateName</code>) if necessary:</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">certreq -submit -<span class="hljs-built_in">attrib</span> &quot;CertificateTemplate:WebServer&quot; adfs.csr adfs.cer<br></code></pre></td></tr></table></figure>

<h4 id="Step-3-Convert-the-Issued-Certificate-to-PFX"><a href="#Step-3-Convert-the-Issued-Certificate-to-PFX" class="headerlink" title="Step 3: Convert the Issued Certificate to PFX"></a>Step 3: Convert the Issued Certificate to PFX</h4><p>After your CA issues the certificate, you’ll receive a certificate file (e.g., <code>csr.cer</code>). To combine this certificate with its private key into a PFX file, you can use the <code>certreq</code> tool if the certificate was issued to the same machine where the CSR was generated, ensuring the private key is present.</p>
<ol>
<li><p><strong>Import the Certificate</strong>: First, import the issued certificate back to the machine where you generated the CSR. This step associates the certificate with the private key:</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cmd">certreq -accept adfs.cer<br></code></pre></td></tr></table></figure>
</li>
<li><p><strong>Export to PFX</strong>: Use the MMC (Microsoft Management Console) to export the certificate and private key to a PFX file because this allows you to include the private key and set a password for the PFX file. However, if you prefer using command-line tools and have OpenSSL installed, you can also use OpenSSL for the export if you have access to the private key file separately. For most Windows server environments, especially when dealing with AD CS, the MMC method is recommended and more straightforward for users who generated their CSR on the same server.</p>
</li>
</ol>
<h4 id="Using-MMC-to-Export-the-Certificate"><a href="#Using-MMC-to-Export-the-Certificate" class="headerlink" title="Using MMC to Export the Certificate"></a>Using MMC to Export the Certificate</h4><ol>
<li>Open MMC, add the Certificates snap-in for the Local Computer account.</li>
<li>Navigate to <strong>Personal</strong> &gt; <strong>Certificates</strong>.</li>
<li>Find your imported certificate, right-click on it, select <strong>All Tasks</strong> &gt; <strong>Export…</strong></li>
<li>Follow the wizard to export the certificate and private key, ensuring you select the option to include the private key. Choose the PFX format and set a password when prompted.</li>
</ol>
<h2 id="Install-ADFS-as-SSO-Idp"><a href="#Install-ADFS-as-SSO-Idp" class="headerlink" title="Install ADFS as SSO Idp"></a>Install ADFS as SSO Idp</h2><h3 id="Configure-and-Setting-up-ADFS-Server"><a href="#Configure-and-Setting-up-ADFS-Server" class="headerlink" title="Configure and Setting up ADFS Server"></a>Configure and Setting up ADFS Server</h3><h4 id="Step-1-Add-the-ADFS-Role"><a href="#Step-1-Add-the-ADFS-Role" class="headerlink" title="Step 1: Add the ADFS Role"></a>Step 1: Add the ADFS Role</h4><ol>
<li><strong>Open Server Manager</strong>: Click on the <strong>Start</strong> button, and then click on <strong>Server Manager</strong>.</li>
<li><strong>Add Roles and Features</strong>: In Server Manager, click on <strong>Manage</strong> and then select <strong>Add Roles and Features</strong>.</li>
<li><strong>Before You Begin Page</strong>: Click <strong>Next</strong> if you’re presented with a “Before you begin” page.</li>
<li><strong>Installation Type</strong>: On the <strong>Installation Type</strong> screen, select <strong>Role-based or feature-based installation</strong> and click <strong>Next</strong>.</li>
<li><strong>Server Selection</strong>: Ensure the current server is highlighted under <strong>Server Pool</strong>. Click <strong>Next</strong>.</li>
<li><strong>Server Roles</strong>: Scroll down and check <strong>Active Directory Federation Services</strong>. When prompted to add features that are required for Active Directory Federation Services, click <strong>Add Features</strong>, then click <strong>Next</strong>.</li>
<li><strong>Features</strong>: No additional features are needed unless you have specific requirements. Click <strong>Next</strong>.</li>
<li><strong>AD FS</strong>: The wizard presents an introduction to AD FS. Read the information if desired and click <strong>Next</strong>.</li>
<li><strong>Confirmation</strong>: Review your selections. You can choose to <strong>Restart the destination server automatically if required</strong>. Click <strong>Install</strong>.</li>
<li><strong>Results</strong>: Wait for the installation process to complete. Click <strong>Close</strong> when done.</li>
</ol>
<h4 id="Step-2-Configure-the-ADFS-Service"><a href="#Step-2-Configure-the-ADFS-Service" class="headerlink" title="Step 2: Configure the ADFS Service"></a>Step 2: Configure the ADFS Service</h4><p>After installing the ADFS role, you need to configure the ADFS service.</p>
<ol>
<li><strong>Post-Deployment Configuration</strong>: Once the role installation completes, you’ll see a notification flag at the top of the Server Manager. Click on it and select <strong>Configure the federation service on this server</strong>.</li>
<li><strong>AD FS Configuration Wizard</strong>: The AD FS Configuration Wizard starts.<ul>
<li><strong>Welcome</strong>: Choose <strong>Create the first federation server in a federation server farm</strong> and click <strong>Next</strong> if this is your first ADFS server.</li>
<li><strong>Connect to AD DS</strong>: Provide an account with Administrator privileges on the local computer and click <strong>Next</strong>.</li>
<li><strong>Specify Farm</strong>: Specify the SSL certificate for the federation service. You should have already installed an SSL certificate that matches the federation service name you plan to use. Select the certificate from the list.</li>
<li><strong>Specify Service Properties</strong>: Enter the Federation Service Name and Federation Service Display Name. The federation service name should match the common name (CN) of the SSL certificate.</li>
<li><strong>Specify Service Account</strong>: Create or specify a service account that the ADFS service will use. You can use an existing domain user account or a group Managed Service Account (gMSA) if your environment supports it.</li>
<li><strong>Specify Configuration Database</strong>: Choose whether to use a Windows Internal Database (WID) or SQL Server. For most deployments, WID is sufficient.</li>
<li><strong>Review Options</strong>: Review your selections and click <strong>Next</strong>.</li>
<li><strong>Pre-requisite Checks</strong>: The wizard will perform pre-requisite checks. If everything is okay, click <strong>Configure</strong>.</li>
<li><strong>Results</strong>: After the configuration is complete, review the results and click <strong>Close</strong>.</li>
</ul>
</li>
</ol>
<h3 id="Test-ADFS-login"><a href="#Test-ADFS-login" class="headerlink" title="Test ADFS login"></a>Test ADFS login</h3><ol>
<li><p>Once the configuration is complete, open the ADFS Management Console from the Server Manager Tools menu.</p>
</li>
<li><p>Check the <strong>ADFS</strong> service status to ensure it’s running.</p>
</li>
<li><p>Navigate to <strong><a target="_blank" rel="noopener" href="https://adfs.ussrelab.com/adfs/ls/idpinitiatedsignon.htm">https://adfs.ussrelab.com/adfs/ls/idpinitiatedsignon.htm</a></strong> from a web browser to test the sign-on page. You might need to enable this page via PowerShell if it’s not already enabled.</p>
<blockquote>
<p><strong>Note</strong>: If the IdP-initiated sign-on page is not enabled, you can enable it by running the following PowerShell command on the ADFS server:</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-built_in">Set-AdfsProperties</span> <span class="hljs-literal">-EnableIdpInitiatedSignonPage</span> <span class="hljs-variable">$true</span><br></code></pre></td></tr></table></figure></blockquote>
</li>
</ol>
<p>​	<img src="https://felixyanghui.synology.me:8441/images/2024/02/05/image-20240204224848224.png" srcset="/img/loading.gif" lazyload alt="image-20240204224848224" style="zoom:50%;" /></p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205162005715.png" srcset="/img/loading.gif" lazyload alt="image-20240205162005715"></p>
<p>[^Internal AD service setup guide]: <a target="_blank" rel="noopener" href="https://wiki.jarvis.trendmicro.com/display/DS/How+to+set+up+Active+Directory+service+for+testing">How to set up Active Directory service for testing</a><br>[^ZTSA SSO auth flow]: <a target="_blank" rel="noopener" href="https://wiki.jarvis.trendmicro.com/display/ZTH/ZTSA+Agent+SSO+auth+flow">https://wiki.jarvis.trendmicro.com/display/ZTH/ZTSA+Agent+SSO+auth+flow</a><br>[^ZTSA SSO and transparent auth]: <a target="_blank" rel="noopener" href="https://wiki.jarvis.trendmicro.com/display/ZTH/ZTSA+SSO+and+transparent+authentication">https://wiki.jarvis.trendmicro.com/display/ZTH/ZTSA+SSO+and+transparent+authentication</a></p>
<h1 id="Vision-One-SASE-x2F-ZTSA-Testing"><a href="#Vision-One-SASE-x2F-ZTSA-Testing" class="headerlink" title="Vision One SASE&#x2F;ZTSA Testing"></a>Vision One SASE&#x2F;ZTSA Testing</h1><h2 id="Setting-up-3rd-Party-Integration-with-On-premise-AD"><a href="#Setting-up-3rd-Party-Integration-with-On-premise-AD" class="headerlink" title="Setting up 3rd Party Integration with On-premise AD"></a>Setting up 3rd Party Integration with On-premise AD</h2><p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205111831551.png" srcset="/img/loading.gif" lazyload alt="image-20240205111831551"></p>
<h2 id="Setting-up-Vision-One-IAM-SSO-with-ADFS"><a href="#Setting-up-Vision-One-IAM-SSO-with-ADFS" class="headerlink" title="Setting up Vision One IAM SSO with ADFS"></a>Setting up Vision One IAM SSO with ADFS</h2><h4 id="Step-1-Export-ADFS-Federation-Metadata-XML"><a href="#Step-1-Export-ADFS-Federation-Metadata-XML" class="headerlink" title="Step 1: Export ADFS Federation Metadata XML"></a>Step 1: Export ADFS Federation Metadata XML</h4><ol>
<li><p><strong>Locate the ADFS Federation Metadata URL</strong>: By default, ADFS publishes its federation metadata at a URL following this pattern: <code>https://&lt;Your_ADFS_Server_FQDN&gt;/FederationMetadata/2007-06/FederationMetadata.xml</code>. Replace <code>&lt;Your_ADFS_Server_FQDN&gt;</code> with the Fully Qualified Domain Name of your ADFS server.</p>
</li>
<li><p><strong>Download the Federation Metadata</strong>:</p>
<ul>
<li>Open a web browser and navigate to the ADFS federation metadata URL.</li>
<li>The federation metadata XML should be displayed in the browser. Right-click the page and choose the option to save the page as an XML file on your computer.</li>
</ul>
</li>
</ol>
<h4 id="Step-2-Provide-the-Metadata-XML-to-Your-Application"><a href="#Step-2-Provide-the-Metadata-XML-to-Your-Application" class="headerlink" title="Step 2: Provide the Metadata XML to Your Application"></a>Step 2: Provide the Metadata XML to Your Application</h4><ol>
<li><p><strong>Upload the Federation Metadata XML</strong>: Create Identify provider on V1 console as below,  by uploading the XML file you saved from your ADFS server. </p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205111630206.png" srcset="/img/loading.gif" lazyload alt="image-20240205111630206"></p>
</li>
</ol>
<h4 id="Step-3-Create-a-Relying-Party-Trust-in-ADFS"><a href="#Step-3-Create-a-Relying-Party-Trust-in-ADFS" class="headerlink" title="Step 3: Create a Relying Party Trust in ADFS"></a>Step 3: Create a Relying Party Trust in ADFS</h4><p>For ADFS to trust and send assertions to your application, you must create a relying party trust for the application in ADFS:</p>
<ol>
<li><p><strong>Open the ADFS Management Console</strong>: On your ADFS server, open the ADFS Management snap-in.</p>
</li>
<li><p><strong>Add Relying Party Trust</strong>:</p>
<ul>
<li>Navigate to <strong>Trust Relationships &gt; Relying Party Trusts</strong>.</li>
<li>Click on <strong>Add Relying Party Trust</strong> in the right pane to start the wizard.</li>
<li>If you have federation metadata URL for your application, choose to import data from a URL. If you only have the metadata XML file, choose to import data from a file and provide the path to your application’s metadata XML.</li>
<li>Follow the prompts to configure the trust according to your security requirements and the information provided by your application.</li>
</ul>
</li>
<li><p><strong>Configure Claim Rules</strong>: After creating the trust, you’ll need to configure claim rules that determine what user information (claims) ADFS sends to your application. This typically involves mapping attributes from Active Directory to claim types that your application understands.</p>
<p>Refer to: <a target="_blank" rel="noopener" href="https://docs.trendmicro.com/en-us/documentation/article/trend-vision-one-configuring-active-d">https://docs.trendmicro.com/en-us/documentation/article/trend-vision-one-configuring-active-d</a></p>
<blockquote>
<p>[!WARNING]</p>
<p>It does not work for my ADFS SSO login after I followed <a target="_blank" rel="noopener" href="https://docs.trendmicro.com/en-us/documentation/article/trend-vision-one-configuring-active-d">the help center article of V1</a>, the workaround is to use <code>UPN</code> instead of <code>E-Mail Address </code> for incoming claim type.</p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205113258875.png" srcset="/img/loading.gif" lazyload alt="image-20240205113258875"></p>
</blockquote>
</li>
<li><p><strong>Review and Apply Configuration</strong>: Ensure all configurations are correct and apply them. Your application should now be integrated with ADFS, and users should be able to authenticate using their Active Directory credentials.</p>
</li>
</ol>
<h4 id="Step-4-Test-the-Integration"><a href="#Step-4-Test-the-Integration" class="headerlink" title="Step 4: Test the Integration"></a>Step 4: Test the Integration</h4><ul>
<li><p><strong>Access the Application</strong>: Attempt to log in through the application using an account from your Active Directory.</p>
</li>
<li><p><strong>Verify SSO</strong>: If the integration is successful, you should be redirected to the ADFS login page (if not already authenticated) and then back to the application after authentication, without needing to provide application-specific credentials.</p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205113545043.png" srcset="/img/loading.gif" lazyload alt="image-20240205113545043"></p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205113646124.png" srcset="/img/loading.gif" lazyload alt="image-20240205113646124"></p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205113729972.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>[!NOTE]</p>
<p>SAML authentication failed for Vision One is due to the SSO SAML acount was not configured and verified as I have not configured the email MTA and account yet, however the ADFS SSO login authentication is completed without any problem actually if you see above page.</p>
</blockquote>
</li>
</ul>
<h2 id="Enable-and-ZTSA-Internet-Access"><a href="#Enable-and-ZTSA-Internet-Access" class="headerlink" title="Enable and ZTSA Internet Access"></a>Enable and ZTSA Internet Access</h2><h4 id="Set-up-on-premise-Zero-Trust-Internet-Access-Gateway-and-your-test-endpoint"><a href="#Set-up-on-premise-Zero-Trust-Internet-Access-Gateway-and-your-test-endpoint" class="headerlink" title="Set up on-premise Zero Trust Internet Access Gateway and your test endpoint"></a>Set up on-premise Zero Trust Internet Access Gateway and your test endpoint</h4><p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205114411368.png" srcset="/img/loading.gif" lazyload alt="image-20240205114411368"></p>
<blockquote>
<p>[!NOTE]</p>
<p>Two important things:</p>
<ol>
<li><p>Need to enable “Zero Trust Secure Acces On-Premises Gateway service” on service gateway</p>
</li>
<li><p>Create your PAC file and configure your web browser to use the PAC file</p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205120125707.png" srcset="/img/loading.gif" lazyload alt="image-20240205120125707"></p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205120313293.png" srcset="/img/loading.gif" lazyload alt="image-20240205120313293"></p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205120217988.png" srcset="/img/loading.gif" lazyload alt="image-20240205120217988"></p>
</li>
</ol>
</blockquote>
<h4 id="Option-1-ZTSA-SSO-Authentication-with-ADFS-Idp"><a href="#Option-1-ZTSA-SSO-Authentication-with-ADFS-Idp" class="headerlink" title="Option-1: ZTSA SSO Authentication with ADFS Idp"></a>Option-1: ZTSA SSO Authentication with ADFS Idp</h4><ol>
<li><p>The authentication flow is as below (3rd patry Idp refers to the ADFS server in our lab)</p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205114817897.png" srcset="/img/loading.gif" lazyload alt="image-20240205114817897"></p>
</li>
<li><p>When you browse the web sites at 1st time from test endpoint, you would be redirected to the SSO login page. After authentication, you will be able to continue to access the destinated web site you want to access.</p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205115329917.png" srcset="/img/loading.gif" lazyload alt="image-20240205115329917"></p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205115418648.png" srcset="/img/loading.gif" lazyload alt="image-20240205115418648"></p>
<blockquote>
<p>[!NOTE]</p>
<p>As I have configured a rule “USSRELAB-TEST-ALLOW”, which blocked all search engines, so my access to “<a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a>“ is blocked by ZTSA after my SSO authentication, it is expected and also verifies ZTSA is functioning.</p>
<p>Below is my ZTSA rule configuration</p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205115854740.png" srcset="/img/loading.gif" lazyload alt="image-20240205115854740"></p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205115759167.png" srcset="/img/loading.gif" lazyload alt="image-20240205115759167"></p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205115820278.png" srcset="/img/loading.gif" lazyload alt="image-20240205115820278"></p>
</blockquote>
</li>
</ol>
<h4 id="Option-2-ZTSA-SSO-Authentication-with-Active-Directory-on-premise"><a href="#Option-2-ZTSA-SSO-Authentication-with-Active-Directory-on-premise" class="headerlink" title="Option-2: ZTSA SSO Authentication with Active Directory (on-premise)"></a>Option-2: ZTSA SSO Authentication with Active Directory (on-premise)</h4><p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205114632768.png" srcset="/img/loading.gif" lazyload alt="image-20240205114632768"></p>
<p>Redirect to your local AD for SSO:  “<a target="_blank" rel="noopener" href="https://sg.ussrelab.com:8089/v1/sso">https://sg.ussrelab.com:8089/v1/sso</a>“ instead of your ADFS Idp, as you configured to use your local AD for SSO.</p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205120705070.png" srcset="/img/loading.gif" lazyload alt="image-20240205120705070"></p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205120736731.png" srcset="/img/loading.gif" lazyload alt="image-20240205120736731"></p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205120809525.png" srcset="/img/loading.gif" lazyload alt="image-20240205120809525"></p>
<p><img src="https://felixyanghui.synology.me:8441/images/2024/02/06/image-20240205120837956.png" srcset="/img/loading.gif" lazyload alt="image-20240205120837956"></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%8A%80%E6%9C%AF%E6%96%87%E7%AB%A0/" class="category-chain-item">技术文章</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/V1/" class="print-no-link">#V1</a>
      
        <a href="/tags/Trend/" class="print-no-link">#Trend</a>
      
        <a href="/tags/ADFS/" class="print-no-link">#ADFS</a>
      
        <a href="/tags/Service-Gateway/" class="print-no-link">#Service Gateway</a>
      
        <a href="/tags/ZTSA/" class="print-no-link">#ZTSA</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>USSRELAB - Vision One SSO with ADFS Idp and ZTSA Testing</div>
      <div>https://blog.excelsre.com/2024/02/04/ussrelab-v1/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Felix Yang</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年2月5日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/01/21/cicd-build-test-and-deploy-containers-to-acr-aks-using-github-actions/" title="CICD - Build, test, and deploy containers to ACR/AKS using GitHub Actions">
                        <span class="hidden-mobile">CICD - Build, test, and deploy containers to ACR/AKS using GitHub Actions</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://github.com/felixyh" target="_blank" rel="nofollow noopener"><span>Yixiao</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/felixyh" target="_blank" rel="nofollow noopener"><span>Yizhen</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
